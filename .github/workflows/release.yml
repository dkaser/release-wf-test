on:
  release:
    types:
      - prereleased
      - released

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Release Action
        uses: dkaser/unraid-plugin-release-action@main
        id: release_action
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          composer_dir: "src/usr/local/php/plugin-name/"
          go_dir: "fileactivity-watcher"
          build_script: |
            cd fileactivity-watcher
            ./build.sh

      # # Print out the commit SHA
      # - name: Print commit SHA
      #   run: echo "Commit SHA ${{ steps.release_action.outputs.commit_long_sha }}"

      - name: Notify Discord
        uses: dkaser/discord-webhook-notify@main
        with:
          webhookUrl: ${{ secrets.TEST_DISCORD_WEBHOOK }}
          username: Tailscale Bot
          avatarUrl: https://raw.githubusercontent.com/unraid/unraid-tailscale/refs/heads/trunk/logo.png
          title: |
            ðŸš€ **Tailscale ${{ github.event.release.prerelease && 'Preview' || 'Release' }} : ${{ github.event.release.name }}**
          severity: info # only to make sure the embed is added
          color: '#ff00aa'
          description: ${{ github.event.release.body }}
          linkUrl: ${{ github.event.release.html_url }}
          fields: |
            [
              {"name": "Changelog", "value": ${{ toJson(github.event.release.body) }}, "inline": false},
              {"name": "Released by", "value": ${{ toJson(github.event.release.author.login) }}, "inline": true},
              {"name": "Tag", "value": ${{ toJson(github.event.release.tag_name) }}, "inline": true}
            ]
